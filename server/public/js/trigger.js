var MODULE="LFIB4";
(function(exports){function Mash(){var n=4022871197;var mash=function(data){data=data.toString();for(var i=0;i<data.length;i++){n+=data.charCodeAt(i);var h=0.02519603282416938*n;n=h>>>0;h-=n;h*=n;n=h>>>0;h-=n;n+=h*4294967296}return(n>>>0)*2.3283064365386963E-10};mash.version="Mash 0.9";return mash}exports.LFIB4=function(){return function(args){var k0=0,k1=58,k2=119,k3=178;var s=[];var mash=Mash();if(args.length===0)args=[+new Date];for(var j=0;j<256;j++){s[j]=mash(" ");s[j]-=mash(" ")*4.76837158203125E-7;
if(s[j]<0)s[j]+=1}for(var i=0;i<args.length;i++)for(var j=0;j<256;j++){s[j]-=mash(args[i]);s[j]-=mash(args[i])*4.76837158203125E-7;if(s[j]<0)s[j]+=1}mash=null;var random=function(){var x;k0=k0+1&255;k1=k1+1&255;k2=k2+1&255;k3=k3+1&255;x=s[k0]-s[k1];if(x<0)x+=1;x-=s[k2];if(x<0)x+=1;x-=s[k3];if(x<0)x+=1;return s[k0]=x};random.uint32=function(){return random()*4294967296>>>0};random.fract53=random;random.version="LFIB4 0.9";random.args=args;return random}(Array.prototype.slice.call(arguments))}})(typeof exports===
"undefined"?this[MODULE]={}:exports);var MODULE="util";
(function(exports){var THREE=this.THREE||require("../THREE");var Vec3=THREE.Vector3;var Quat=THREE.Quaternion;exports.TWOPI=Math.PI*2;exports.PULLTOWARD=function(val,target,delta){return target+(val-target)/(1+delta)};exports.MOVETOWARD=function(val,target,delta){var moved;if(target<(moved=val-delta))return moved;else if(target>(moved=val+delta))return moved;else return target};exports.INTERP=function(a,b,f){return a+(b-a)*f};exports.CLAMP=function(a,min,max){return Math.min(Math.max(a,min),max)};
exports.Vec3FromArray=function(arr){return new Vec3(arr[0],arr[1],arr[2])};exports.QuatFromEuler=function(angles){var q=new Quat;q.setFromAxisAngle(new Vec3(1,0,0),angles.x);q.multiplySelf((new Quat).setFromAxisAngle(new Vec3(0,1,0),angles.y));q.multiplySelf((new Quat).setFromAxisAngle(new Vec3(0,0,1),angles.z));return q};exports.KEYCODE={SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40};(function(){for(var cc=48;cc<127;++cc)exports.KEYCODE[String.fromCharCode(cc)]=cc})();exports.CallbackQueue=function(callback){this.callbacks=
[];if(callback)this.callbacks.push(callback)};exports.CallbackQueue.prototype.add=function(callback){this.callbacks.push(callback)};exports.CallbackQueue.prototype.fire=function(){for(var i=0;i<this.callbacks.length;++i)this.callbacks[i].apply(undefined,arguments)};exports.arraySlice=Function.prototype.call.bind(Array.prototype.slice)})(typeof exports==="undefined"?this[MODULE]={}:exports);var MODULE="pubsub";(function(exports){var util=this.util||require("./util");exports.PubSub=function(){this.handlers=[]};exports.PubSub.prototype.subscribe=function(topic,fn){var handler=this.handlers[topic]||(this.handlers[topic]=[]);handler.push(fn)};exports.PubSub.prototype.publish=function(topic){var handler=this.handlers[topic];if(handler)handler.forEach(function(fn){fn.apply(null,util.arraySlice(arguments,1))})}})(typeof exports==="undefined"?this[MODULE]={}:exports);var MODULE="recorder";
(function(exports){var _=this._||require("underscore");var pubsub=this.pubsub||require("./pubsub");exports.StateRecorder=function(object,keys,freq){this.timeline=[];this.keys=keys;this.keyMap=generateKeyMap(keys);this.freqCount=0;this.index=0;this.freq=freq;this.object=object;this.lastState=null;this.lastDiff=null};exports.StateRecorder.prototype.observe=function(){if(this.freq){if(++this.freqCount!=this.freq)return;this.freqCount=0}var newState=filterObject(this.object,this.keys);if(this.lastState){var stateDiff=
objDiff(newState,this.lastState);if(!_.isEmpty(stateDiff)){var remapped=remapKeys(this.lastDiff,this.keyMap);this.timeline.push([this.index,remapped]);this.lastDiff=stateDiff;this.lastState=newState;this.index=0}}else this.lastDiff=this.lastState=newState;++this.index};exports.StateRecorder.prototype.serialize=function(){var reverseMap={};for(var k in this.keyMap)reverseMap[this.keyMap[k]]=k;var remapped=remapKeys(this.lastDiff,this.keyMap);this.timeline.push([this.index,remapped]);this.lastDiff=
{};this.index=0;return{freq:this.freq,keyMap:reverseMap,timeline:this.timeline}};exports.StatePlayback=function(object,serialized){this.object=object;this.serialized=serialized;this.index=0;this.freq=serialized.freq;this.freqCount=0;this.nextSeg=0;this.pubsub=new pubsub.PubSub};exports.StatePlayback.prototype.step=function(){if(this.freq){if(++this.freqCount!=this.freq)return;this.freqCount=0}var seg=this.serialized.timeline[this.nextSeg];if(seg){applyDiff(this.object,seg[1],this.serialized.keyMap);
if(++this.index>=seg[0]){this.index=0;if(++this.nextSeg>=this.serialized.timeline.length)this.pubsub.publish("complete")}}};function objDiff(a,b){var changed={};for(var k in a){aVal=a[k];if(_.isArray(aVal))changed[k]=a[k];else if(typeof aVal==="object"){var c=objDiff(aVal,b[k]);if(!_.isEmpty(c))changed[k]=c}else if(aVal!==b[k])changed[k]=aVal}return changed}function applyDiff(obj,diff,keyMap){if(_.isArray(diff)){diff.forEach(function(el,index){obj[index]=applyDiff(obj[index],el,keyMap)});return obj}else if(typeof diff===
"object"){_.each(diff,function(val,key){obj[keyMap[key]]=applyDiff(obj[keyMap[key]],val,keyMap)});return obj}else return parseFloat(diff)}function generateKeyMap(keys){var keyMap={};var nextKey=0;function process(keys){_.each(keys,function(val,key){if(!(key in keyMap))keyMap[key]=(nextKey++).toString(36);if(_.isArray(val))process(val[0]);else if(typeof val==="object")process(val)})}process(keys);return keyMap}function remapKeys(object,keyMap){if(_.isArray(object)){var remapped=[];object.forEach(function(el){remapped.push(remapKeys(el,
keyMap))});return remapped}else if(typeof object==="object"){var remapped={};_.each(object,function(val,objKey){var key=keyMap[objKey];remapped[key]=remapKeys(val,keyMap)});return remapped}else return object}function objEqual(a,b){for(var k in a)if(typeof a[k]==="object"){if(!objEqual(a[k],b[k]))return false}else if(a[k]!==b[k])return false;return true}var filterObject=function(obj,keys){if(_.isArray(keys)){var subKeys=keys[0];var result=[];obj.forEach(function(el){result.push(filterObject(el,subKeys))});
return result}else if(typeof keys==="object"){var result={};_.each(keys,function(val,key){result[key]=filterObject(obj[key],val)});return result}else return obj.toFixed(keys)}})(typeof exports==="undefined"?this[MODULE]={}:exports);var MODULE="pterrain";
(function(exports){var THREE=this.THREE||require("../THREE");var Vec3=THREE.Vector3;var inNode=false;if(typeof Image==="undefined"){inNode=true;var Canvas=require("canvas")}exports.ImageSource=function(){this.hmap=null;this.onload=[]};exports.ImageSource.prototype.load=function(url,callback){if(inNode){var path=__dirname+"/../public"+url;require("fs").readFile(path,function(err,data){if(err)throw new Error(err);else{var img=new Canvas.Image;img.src=data;this.loadWithImage(img,callback)}}.bind(this))}else{var image=
new Image;image.onload=this.loadWithImage.bind(this,image,callback);image.src=url}};exports.ImageSource.prototype.loadWithImage=function(image,callback){var cx=this.cx=image.width;var cy=this.cy=image.height;var canvas;if(inNode)canvas=new Canvas(cx,cy);else{canvas=document.createElement("canvas");canvas.width=cx;canvas.height=cy}var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0);this.hmap=ctx.getImageData(0,0,cx,cy).data;for(var i in this.onload)this.onload[i]();if(callback)callback(this)};
exports.ImageSource.prototype.loadTile=function(x,y,cx,cy,scaleVt,callback){if(!this.hmap){this.onload.push(this.loadTile.bind(this,x,y,cx,cy,scaleVt,callback));return}var srcx=this.cx;var srcy=this.cy;var data=this.hmap;var buffer=new Float32Array(cx*cy);var ix,iy,i=0;for(iy=y;iy<y+cy;++iy){var wrapy=iy%srcy;if(wrapy<0)wrapy+=srcy;var wrapy_srcx=wrapy*srcx;for(ix=x;ix<x+cx;++ix){var wrapx=ix%srcx;if(wrapx<0)wrapx+=srcx;buffer[++i]=data[(wrapx+wrapy_srcx)*4]*scaleVt}}callback(buffer)};exports.Terrain=
function(source){this.tileSize=128;this.scaleHz=1;this.scaleVt=1;this.tileTotalSize=this.tileSize*this.scaleHz;this.tiles={};this.source=source};exports.Terrain.prototype.getTile=function(tx,ty){var key=tx+","+ty;return this.tiles[key]};exports.Terrain.prototype.loadTile=function(tx,ty,callback){var key=tx+","+ty;if(key in this.tiles)callback(this.tiles[key]);else{var size=this.tileSize;var sizeP1=size+1;this.source.loadTile(tx*size,ty*size,sizeP1,sizeP1,this.scaleVt,function(heightMap){var tile=
new exports.TerrainTile(this,tx,ty,heightMap);this.tiles[key]=tile;if(callback)callback(tile)}.bind(this))}};exports.Terrain.prototype.getContact=function(pt){return this.getContactRayZ(pt.x,-pt.z)};exports.Terrain.prototype.getContactRayZ=function(x,y){var contact=null;var sx=x/this.scaleHz;var sy=y/this.scaleHz;var tx=Math.floor(sx/this.tileSize);var ty=Math.floor(sy/this.tileSize);var tile=this.getTile(tx,ty);if(tile){contact=tile.getContactRayZ(sx-tx*this.tileSize,sy-ty*this.tileSize);if(contact){contact.surfacePos.x=
x;contact.surfacePos.z=-y}}else;return contact};exports.TerrainTile=function(terrain,tx,ty,heightMap){var that=this;this.terrain=terrain;this.size=terrain.tileSize;var sizeP1=this.size+1;this.heightMap=heightMap};exports.TerrainTile.prototype.getContactRayZ=function(lx,ly){var floorlx=Math.floor(lx);var floorly=Math.floor(ly);var fraclx=lx-floorlx;var fracly=ly-floorly;var sizeP1=this.size+1;var h00=this.heightMap[floorlx+0+(floorly+0)*sizeP1];var h10=this.heightMap[floorlx+1+(floorly+0)*sizeP1];
var h01=this.heightMap[floorlx+0+(floorly+1)*sizeP1];var h11=this.heightMap[floorlx+1+(floorly+1)*sizeP1];var normal=new Vec3;var height;normal.z=this.terrain.scaleHz;if(fraclx+fracly<1){normal.x=h00-h10;normal.y=h00-h01;height=h00+(h10-h00)*fraclx+(h01-h00)*fracly}else{normal.x=h01-h11;normal.y=h10-h11;height=h11+(h01-h11)*(1-fraclx)+(h10-h11)*(1-fracly)}return{normal:(new Vec3(normal.x,normal.z,-normal.y)).normalize(),surfacePos:new Vec3(0,height,0)}}})(typeof exports==="undefined"?this[MODULE]=
{}:exports);var MODULE="psim";
(function(exports){var THREE=this.THREE||require("../THREE");var pubsub=this.pubsub||require("./pubsub");var util=this.util||require("./util");var Vec3=THREE.Vector3;var Quat=THREE.Quaternion;var QuatFromEuler=util.QuatFromEuler;exports.Sim=function(timeStep){this.gravity=new Vec3(0,-9.81,0);this.objects=[];this.staticObjects=[];this.cylinders=[];this.cylLists={};this.time=0;this.timeAccumulator=0;this.timeStep=timeStep;this.alpha=0;this.pubsub=new pubsub.PubSub};exports.Sim.prototype.addObject=function(obj){this.objects.push(obj)};
exports.Sim.prototype.addStaticObject=function(obj){this.staticObjects.push(obj)};exports.Sim.prototype.tick=function(delta){if(delta<=0)return;if(delta>0.1)delta=0.1;var timeStep=this.timeStep;this.timeAccumulator+=delta;while(this.timeAccumulator>=timeStep){this.timeAccumulator-=timeStep;this.step()}this.alpha=this.timeAccumulator/timeStep;this.objects.forEach(function(object){if(typeof object.getState==="function")object.interp=object.getState()})};exports.Sim.prototype.step=function(){this.pubsub.publish("step");
this.integrate(this.timeStep);this.time+=this.timeStep};exports.Sim.prototype.interpolatedTime=function(){return this.time+this.timeAccumulator};exports.Sim.prototype.integrate=function(delta){this.objects.forEach(function(object){if(typeof object.recordState==="function")object.recordState()});this.objects.forEach(function(object){object.tick(delta)})};exports.Sim.prototype.collide=function(pt){var i,contacts=[];var tmp1=new Vec3;var tmp2=new Vec3;for(i=0;i<this.staticObjects.length;++i){var contact=
this.staticObjects[i].getContact(pt);if(contact){var contactOffset=tmp1.copy(contact.surfacePos).subSelf(pt);contact.depth=contactOffset.dot(contact.normal);if(contact.depth>0)contacts.push(contact)}}var cylVec=new Vec3(0,1,0);var cylList=this.getCylList(pt);if(cylList)cylList.forEach(function(cyl){tmp2.copy(pt).subSelf(cyl);var normal=tmp2.subSelf(tmp1.copy(cylVec).multiplyScalar(tmp2.dot(cylVec)));var leng=normal.length();if(leng<cyl.radius){var depth=cyl.radius-leng;var contact={normal:normal.clone(),
surfacePos:pt.addSelf(tmp1.copy(normal).multiplyScalar(depth)),depth:depth};contacts.push(contact)}});return contacts};var CYLINDER_BLOCK_INV=0.1;var cylListKey=function(a,b){return Math.round(a*CYLINDER_BLOCK_INV)+","+Math.round(b*CYLINDER_BLOCK_INV)};exports.Sim.prototype.getCylList=function(pt){return this.cylLists[cylListKey(pt.x,pt.z)]};exports.Sim.prototype.addCylinder=function(cyl){this.cylinders.push(cyl);var cx=Math.round(cyl.x*CYLINDER_BLOCK_INV);var cy=Math.round(cyl.z*CYLINDER_BLOCK_INV);
var crad=Math.ceil(cyl.radius*CYLINDER_BLOCK_INV);var x,y;for(y=-crad;y<=crad;++y)for(x=-crad;x<=crad;++x){var key=x+cx+","+(y+cy);var cylList=this.cylLists[key]||(this.cylLists[key]=[]);cylList.push(cyl)}};exports.Sim.prototype.collideConvexHull=function(hull,center,radius){var cylVec=new Vec3(0,1,0);var radiusSquared=radius*radius;this.cylinders.forEach(function(cyl){var dist=new Vec3.sub(cyl,center);if(dist.lengthSq()<=radiusSquared);})};exports.Sim.prototype.collideLineSegment=function(pt1,pt2){var i,
contacts=[];var direc=pt2.clone().subSelf(pt1);var leng=direc.length();direc.divideScalar(leng);var cylVec=new Vec3(0,1,0);var cross=(new Vec3).cross(cylVec,direc);var lambda1=cross.dot(pt1);for(i=0;i<this.cylinders.length;++i){var cyl=this.cylinders[i];var lambda2=cross.dot(cyl);if(Math.abs(lambda1-lambda2)<cyl.radius){var dlambdac=direc.dot(cyl)-direc.dot(pt1);if(dlambdac>0&&dlambdac<leng){var ptOnLine=direc.clone().multiplyScalar(dlambdac).addSelf(pt1);var tmpVec=ptOnLine.clone().subSelf(cyl);
var normal=tmpVec.subSelf(cylVec.clone().multiplyScalar(tmpVec.dot(cylVec)));normal.normalize();var embedFactor=ptOnLine.clone().subSelf(cyl).dot(normal);var depth=cyl.radius-embedFactor;var contact={normal:normal,surfacePos:ptOnLine.addSelf(normal.clone().multiplyScalar(depth)),depth:depth};contacts.push(contact)}}}return contacts};exports.ReferenceFrame=function(){this.pos=new Vec3;this.ori=new Quat;this.oriMat=new THREE.Matrix4;this.oriMatInv=new THREE.Matrix4};exports.ReferenceFrame.prototype.updateMatrices=
function(){this.ori.normalize();this.oriMat.setRotationFromQuaternion(this.ori);this.oriMatInv.copy(this.oriMat).transpose()};exports.ReferenceFrame.prototype.getLocToWorldVector=function(vec){var v=vec.clone();this.oriMat.multiplyVector3(v);return v};exports.ReferenceFrame.prototype.getWorldToLocVector=function(vec){var v=vec.clone();this.oriMatInv.multiplyVector3(v);return v};exports.ReferenceFrame.prototype.getLocToWorldPoint=function(pt){var v=pt.clone();this.oriMat.multiplyVector3(v);v.addSelf(this.pos);
return v};exports.ReferenceFrame.prototype.getWorldToLocPoint=function(pt){var v=pt.clone().subSelf(this.pos);this.oriMatInv.multiplyVector3(v);return v};exports.RigidBody=function(sim){exports.ReferenceFrame.call(this);this.sim=sim;sim.addObject(this);this.angMass=new Vec3;this.angMassInv=new Vec3;this.setMassCuboid(1,new Vec3(1,1,1));this.linVel=new Vec3;this.angVel=new Vec3;this.accumForce=new Vec3;this.accumTorque=new Vec3;this.recordState()};exports.RigidBody.prototype=Object.create(new exports.ReferenceFrame);
exports.RigidBody.prototype.recordState=function(){this.old={pos:this.pos.clone(),ori:(new Quat).copy(this.ori),linVel:this.linVel.clone(),angVel:this.angVel.clone()}};exports.RigidBody.prototype.getState=function(){var a=this.old,b=this,alpha=this.sim.alpha;return{pos:new Vec3(a.pos.x+(b.pos.x-a.pos.x)*alpha,a.pos.y+(b.pos.y-a.pos.y)*alpha,a.pos.z+(b.pos.z-a.pos.z)*alpha),ori:new Quat(a.ori.x+(b.ori.x-a.ori.x)*alpha,a.ori.y+(b.ori.y-a.ori.y)*alpha,a.ori.z+(b.ori.z-a.ori.z)*alpha,a.ori.w+(b.ori.w-
a.ori.w)*alpha),linVel:new Vec3(a.linVel.x+(b.linVel.x-a.linVel.x)*alpha,a.linVel.y+(b.linVel.y-a.linVel.y)*alpha,a.linVel.z+(b.linVel.z-a.linVel.z)*alpha),angVel:new Vec3(a.angVel.x+(b.angVel.x-a.angVel.x)*alpha,a.angVel.y+(b.angVel.y-a.angVel.y)*alpha,a.angVel.z+(b.angVel.z-a.angVel.z)*alpha)}};exports.RigidBody.prototype.setMassCuboid=function(mass,radiusVec){if(mass<=0||radiusVec.x<=0||radiusVec.y<=0||radiusVec.z<=0)return;this.mass=mass;this.angMass.x=radiusVec.y*radiusVec.z;this.angMass.y=radiusVec.z*
radiusVec.x;this.angMass.z=radiusVec.x*radiusVec.y;this.angMass.multiplyScalar(mass);this.angMassInv.x=1/this.angMass.x;this.angMassInv.y=1/this.angMass.y;this.angMassInv.z=1/this.angMass.z};exports.RigidBody.prototype.getLinearVel=function(){return this.linVel};exports.RigidBody.prototype.addForce=function(frc){this.accumForce.addSelf(frc)};exports.RigidBody.prototype.addLocForce=function(frc){this.addForce(this.getLocToWorldVector(frc))};exports.RigidBody.prototype.addForceAtPoint=function(frc,
pt){this.accumForce.addSelf(frc);var ptLoc=this.getWorldToLocPoint(pt);var frcLoc=this.getWorldToLocVector(frc);var torque=(new Vec3).cross(ptLoc,frcLoc);this.addTorque(torque)};exports.RigidBody.prototype.addLocForceAtPoint=function(frc,pt){this.addForceAtPoint(this.getLocToWorldVector(frc),pt)};exports.RigidBody.prototype.addForceAtLocPoint=function(frc,pt){this.addForceAtPoint(frc,this.getLocToWorldPoint(pt))};exports.RigidBody.prototype.addLocForceAtLocPoint=function(frc,pt){this.addForceAtPoint(this.getLocToWorldVector(frc),
this.getLocToWorldPoint(pt))};exports.RigidBody.prototype.addTorque=function(trq){this.accumTorque.addSelf(trq)};exports.RigidBody.prototype.addLocTorque=function(trq){this.addTorque(this.getLocToWorldVector(trq))};exports.RigidBody.prototype.getLinearVelAtPoint=function(pt){var ptLoc=pt.clone().subSelf(this.pos);var angVel2=this.getLocToWorldVector(this.angVel);var cross=(new Vec3).cross(angVel2,ptLoc);return(new Vec3).add(this.linVel,cross)};exports.RigidBody.prototype.tick=function(delta){var linAccel=
this.accumForce.clone().divideScalar(this.mass);linAccel.addSelf(this.sim.gravity);this.linVel.addSelf(linAccel.multiplyScalar(delta));this.pos.addSelf(this.linVel.clone().multiplyScalar(delta));var angAccel=(new Vec3).multiply(this.accumTorque,this.angMassInv);this.angVel.addSelf(angAccel.clone().multiplyScalar(delta));var angDelta=this.angVel.clone().multiplyScalar(delta);var angDeltaQuat=QuatFromEuler(angDelta);this.ori.multiplySelf(angDeltaQuat);this.accumForce.x=this.accumForce.y=this.accumForce.z=
0;this.accumTorque.x=this.accumTorque.y=this.accumTorque.z=0;this.updateMatrices()}})(typeof exports==="undefined"?this[MODULE]={}:exports);var MODULE="pvehicle";
(function(exports){var _=this._||require("underscore");var LFIB4=this.LFIB4||require("./LFIB4");var THREE=this.THREE||require("../THREE");var psim=this.psim||require("./psim");var util=this.util||require("./util");var Vec2=THREE.Vector2;var Vec3=THREE.Vector3;var Quat=THREE.Quaternion;var Vec3FromArray=util.Vec3FromArray;var TWOPI=util.TWOPI;var PULLTOWARD=util.PULLTOWARD;var MOVETOWARD=util.MOVETOWARD;var CLAMP=util.CLAMP;var INTERP=util.INTERP;var CLIP_CONSTANT=2E5;var CLIP_DAMPING=8E3;var SUSP_CONSTANT=
7E4;var SUSP_DAMPING=50;var SUSP_MAX=0.13;var WHEEL_MASS=15;var BUMPS_PER_RADIAN=0.6;var THROTTLE_RESPONSE=8;var BRAKE_RESPONSE=5;var HANDBRAKE_RESPONSE=20;var TURN_RESPONSE=5;var ENGINE_BRAKE_REGION=0.5;var ENGINE_BRAKE_TORQUE=0.1;var REDLINE_RECOVER_FRACTION=0.98;var LSD_VISCOUS_CONSTANT=400;var MIN_TIME_BETWEEN_SHIFTS=0.2;var FRICTION_DYNAMIC_CHASSIS=0.9*0.9;var FRICTION_STATIC_CHASSIS=1.2*0.9;var FRICTION_DYNAMIC_WHEEL=0.9*1.2;var FRICTION_STATIC_WHEEL=1.2*1.2;var RPM_TO_RPS=function(r){return r*
TWOPI/60};function BiasedPull(val,target,deltaUp,deltaDown){if(target>=val)return PULLTOWARD(val,target,deltaUp);else return PULLTOWARD(val,target,deltaDown)}function getEnginePower(angVel,powerband){if(angVel<=0)return 0;if(angVel<=powerband[0].radps)return powerband[0].power*angVel/powerband[0].radps;var p;for(p=1;p<powerband.length;++p)if(angVel<=powerband[p].radps)return INTERP(powerband[p-1].power,powerband[p].power,(angVel-powerband[p-1].radps)/(powerband[p].radps-powerband[p-1].radps));return powerband[p-
1].power}exports.AutomaticController=function(vehicle){this.vehicle=vehicle;this.shiftTimer=0;this.input={forward:0,back:0,left:0,right:0,handbrake:0};this.output={throttle:0,clutch:1,gear:1,brake:0,handbrake:0,desiredTurnPos:0}};exports.AutomaticController.prototype.tick=function(delta){var input=this.input;var output=this.output;var vehicle=this.vehicle;var powerband=vehicle.cfg.engine.powerband;var GetTorque=function(testGear){var testAngVel=vehicle.engineAngVel*vehicle.gearRatios[testGear]/vehicle.gearRatios[output.gear];
var testPower=getEnginePower(testAngVel,powerband);return testPower*vehicle.gearRatios[testGear]/testAngVel};var accel=input.forward;var brake=input.back;var engineAngVel=vehicle.engineAngVel;var currentPower=getEnginePower(vehicle.engineAngVel,powerband);var currentTorque=currentPower*vehicle.gearRatios[output.gear]/vehicle.engineAngVel;if(this.shiftTimer<=0)if(output.clutch&&output.gear>=1){var nextGearRel=0;if(output.gear>1&&GetTorque(output.gear-1)>currentTorque){output.gear-=1;this.shiftTimer=
MIN_TIME_BETWEEN_SHIFTS}else if(output.gear<vehicle.gearRatios.length-1&&GetTorque(output.gear+1)>currentTorque){output.gear+=1;this.shiftTimer=MIN_TIME_BETWEEN_SHIFTS}else if(brake&&vehicle.differentialAngVel<1){output.gear=-1;this.shiftTimer=MIN_TIME_BETWEEN_SHIFTS}}else{if(output.gear==-1)if(accel){output.gear=1;this.shiftTimer=MIN_TIME_BETWEEN_SHIFTS}else{accel=brake;brake=0}}else this.shiftTimer-=delta;output.throttle=PULLTOWARD(output.throttle,accel,delta*THROTTLE_RESPONSE);output.brake=PULLTOWARD(output.brake,
brake,delta*BRAKE_RESPONSE);output.handbrake=PULLTOWARD(output.handbrake,input.handbrake,delta*HANDBRAKE_RESPONSE);output.desiredTurnPos=PULLTOWARD(output.desiredTurnPos,input.left-input.right,delta*TURN_RESPONSE);output.clutch=1;output.clutch*=output.handbrake<0.5?1:0};exports.Vehicle=function(sim,config){this.sim=sim;sim.addObject(this);this.cfg=config;this.body=new psim.RigidBody(sim);this.body.setMassCuboid(config.mass,Vec3FromArray(config.dimensions).multiplyScalar(0.5));this.wheelTurnPos=-1;
this.wheelTurnVel=0;this.totalDrive=0;for(var i=0;i<config.clips.length;++i){var cfg=config.clips[i];cfg.pos[0]-=config.center[0];cfg.pos[1]-=config.center[1];cfg.pos[2]-=config.center[2]}this.wheels=[];for(var w=0;w<config.wheels.length;++w){var wheel=this.wheels[w]={};wheel.cfg=config.wheels[w];wheel.cfg.pos[0]-=config.center[0];wheel.cfg.pos[1]-=config.center[1];wheel.cfg.pos[2]-=config.center[2];wheel.ridePos=0;wheel.rideVel=0;wheel.spinPos=0;wheel.spinVel=0;wheel.bumpLast=0;wheel.bumpNext=0;
wheel.bumpTravel=0;wheel.frictionForce=new Vec2;this.totalDrive+=wheel.cfg.drive||0}this.controller=new exports.AutomaticController(this);for(var p=0;p<config.engine.powerband.length;++p)config.engine.powerband[p].radps=config.engine.powerband[p].rpm*TWOPI/60;this.engineAngVel=0;this.engineAngVelSmoothed=0;this.engineIdle=config.engine.powerband[0].radps;this.engineRedline=config.engine.redline*TWOPI/60;this.engineRecover=this.engineRedline*REDLINE_RECOVER_FRACTION;this.engineOverspeed=false;this.enginePowerscale=
config.engine.powerscale*1E3;var finalRatio=config.transmission["final"];this.gearRatios=[];this.gearRatios[-1]=-config.transmission.reverse*finalRatio;this.gearRatios[0]=0;for(var g=0;g<config.transmission.forward.length;++g)this.gearRatios[g+1]=config.transmission.forward[g]*finalRatio;this.recoverTimer=0;this.crashLevel=0;this.crashLevelPrev=0;this.skidLevel=0;this.disabled=false;this.random=LFIB4.LFIB4(5)};exports.Vehicle.prototype.recordState=function(){};exports.Vehicle.prototype.getState=function(){return{}};
exports.Vehicle.prototype.recover=function(delta){var state=this.recoverState;var body=this.body;if(!state){var angleY=Math.atan2(body.oriMat.elements[8],body.oriMat.elements[0]);var newOri=(new Quat).setFromAxisAngle(new Vec3(0,1,0),Math.PI-angleY);var cosHalfTheta=newOri.x*body.ori.x+newOri.y*body.ori.y+newOri.z*body.ori.z+newOri.w*body.ori.w;if(cosHalfTheta<0){newOri.x*=-1;newOri.y*=-1;newOri.z*=-1;newOri.w*=-1}state=this.recoverState={pos:body.pos.clone().addSelf(Vec3FromArray(this.cfg.recover.posOffset)),
ori:newOri};this.disabled=true}var pull=delta*4;body.pos.x=PULLTOWARD(body.pos.x,state.pos.x,pull);body.pos.y=PULLTOWARD(body.pos.y,state.pos.y,pull);body.pos.z=PULLTOWARD(body.pos.z,state.pos.z,pull);body.ori.x=PULLTOWARD(body.ori.x,state.ori.x,pull);body.ori.y=PULLTOWARD(body.ori.y,state.ori.y,pull);body.ori.z=PULLTOWARD(body.ori.z,state.ori.z,pull);body.ori.w=PULLTOWARD(body.ori.w,state.ori.w,pull);body.linVel.set(0,0,0);body.angVel.set(0,0,0);if(this.recoverTimer>=this.cfg.recover.releaseTime){this.recoverTimer=
0;this.recoverState=null;this.disabled=false}};exports.Vehicle.prototype.tick=function(delta){var c;this.controller.tick(delta);var powerband=this.cfg.engine.powerband;var controls=this.controller.output;var throttle=controls.throttle;if(this.disabled){controls.clutch=0;controls.brake=1;controls.desiredTurnPos=0}this.crashLevelPrev=PULLTOWARD(this.crashLevelPrev,this.crashLevel,delta*5);this.crashLevel=PULLTOWARD(this.crashLevel,0,delta*5);this.skidLevel=0;if(this.body.oriMat.elements[5]<=0.1||this.recoverTimer>=
this.cfg.recover.triggerTime){this.recoverTimer+=delta;if(this.recoverTimer>=this.cfg.recover.triggerTime)this.recover(delta)}else this.recoverTimer=0;var differentialAngVel=0;var wheelLateralForce=0;for(c=0;c<this.wheels.length;++c){var wheel=this.wheels[c];differentialAngVel+=wheel.spinVel*(wheel.cfg.drive||0);wheelLateralForce+=wheel.frictionForce.x}differentialAngVel/=this.totalDrive;this.differentialAngVel=differentialAngVel;var gearRatio=this.gearRatios[controls.gear];if(gearRatio!=0&&controls.clutch)this.engineAngVel=
differentialAngVel*gearRatio;if(this.engineAngVel<this.engineIdle)this.engineAngVel=this.engineIdle;if(this.engineOverspeed){this.engineOverspeed=this.engineAngVel>this.engineRecover;if(this.engineOverspeed){throttle=0;controls.throttle=0}}else if(this.engineAngVel>this.engineRedline){throttle=0;this.engineOverspeed=true}var extendedThrottle=throttle-ENGINE_BRAKE_REGION;if(extendedThrottle>=0)extendedThrottle/=1-ENGINE_BRAKE_REGION;else extendedThrottle/=ENGINE_BRAKE_REGION;var engineTorque;if(extendedThrottle>=
0){var enginePower=extendedThrottle*this.enginePowerscale*getEnginePower(this.engineAngVel,powerband);engineTorque=enginePower/this.engineAngVel}else engineTorque=ENGINE_BRAKE_TORQUE*extendedThrottle*(this.engineAngVel-this.engineIdle);var perWheelTorque=0;if(gearRatio!=0&&controls.clutch){var differentialTorque=engineTorque*gearRatio;perWheelTorque=differentialTorque/this.totalDrive}else{this.engineAngVel+=5E4*engineTorque*delta/this.cfg.engine.flywheel;if(this.engineAngVel<this.engineIdle)this.engineAngVel=
this.engineIdle}for(c=0;c<this.wheels.length;++c){var wheel=this.wheels[c];var wheelTorque=wheel.frictionForce.y*0.3;if(wheel.cfg.drive){var diffSlip=wheel.spinVel-differentialAngVel;var diffTorque=diffSlip*LSD_VISCOUS_CONSTANT;wheelTorque+=(perWheelTorque-diffTorque)*wheel.cfg.drive}wheel.spinVel+=0.13*wheelTorque*delta;var brake=controls.brake*(wheel.cfg.brake||0)+controls.handbrake*(wheel.cfg.handbrake||0);if(brake>0)wheel.spinVel=MOVETOWARD(wheel.spinVel,0,brake*delta)}for(c=0;c<this.cfg.clips.length;++c)this.clipPoint(this.cfg.clips[c]);
for(c=0;c<this.cfg.clipEdges.length;++c)this.clipEdge(this.cfg.clipEdges[c]);var wheelTurnVelTarget=(controls.desiredTurnPos-this.wheelTurnPos)*300+wheelLateralForce*-0.0050;wheelTurnVelTarget=CLAMP(wheelTurnVelTarget,-8,8);this.wheelTurnVel=PULLTOWARD(this.wheelTurnVel,wheelTurnVelTarget,delta*10);this.wheelTurnPos+=this.wheelTurnVel*delta;this.wheelTurnPos=CLAMP(this.wheelTurnPos,-1,1);for(c=0;c<this.cfg.wheels.length;++c)this.tickWheel(this.wheels[c],delta);this.engineAngVelSmoothed=PULLTOWARD(this.engineAngVelSmoothed,
this.engineAngVel,delta*20)};var getSurfaceBasis=function(normal,right){var basis={};basis.w=normal;basis.v=(new Vec3).cross(normal,right);basis.v.normalize();basis.u=(new Vec3).cross(basis.v,normal);basis.u.normalize();return basis};exports.Vehicle.prototype.clipPoint=function(clip){var clipPos=this.body.getLocToWorldPoint(Vec3FromArray(clip.pos));var contactVel=this.body.getLinearVelAtPoint(clipPos);var contacts=this.sim.collide(clipPos);for(var c=0;c<contacts.length;++c)this.contactResponse(contacts[c])};
exports.Vehicle.prototype.clipHull=function(){var convexHull=[new Vec4(1,0,0,this.cfg.dimensions[0]),new Vec4(-1,0,0,-this.cfg.dimensions[0]),new Vec4(0,1,0,this.cfg.dimensions[1]),new Vec4(0,-1,0,-this.cfg.dimensions[1]),new Vec4(0,0,1,this.cfg.dimensions[2]),new Vec4(0,0,-1,-this.cfg.dimensions[2])];convexHull.forEach(function(plane){this.body.oriMat.multiplyVector4(plane)});var RADIUS=5;var contacts=this.sim.collideConvexHull(convexHull,this.body.pos,RADIUS);for(var c=0;c<contacts.length;++c)this.contactResponse(contacts[c])};
exports.Vehicle.prototype.clipEdge=function(edge){var clip1=this.cfg.clips[edge[0]];var clip2=this.cfg.clips[edge[1]];var clipPos1=this.body.getLocToWorldPoint(Vec3FromArray(clip1.pos));var clipPos2=this.body.getLocToWorldPoint(Vec3FromArray(clip2.pos));var contacts=this.sim.collideLineSegment(clipPos1,clipPos2);for(var c=0;c<contacts.length;++c)this.contactResponse(contacts[c])};exports.Vehicle.prototype.contactResponse=function(contact){var surf=getSurfaceBasis(contact.normal,new Vec3(1,0,0));var contactVel=
this.body.getLinearVelAtPoint(contact.surfacePos);var contactVelSurf=new Vec3(contactVel.dot(surf.u),contactVel.dot(surf.v),contactVel.dot(surf.w));var perpForce=contact.depth*CLIP_CONSTANT-contactVelSurf.z*CLIP_DAMPING;if(perpForce>0){var friction=(new Vec2(-contactVelSurf.x,-contactVelSurf.y)).multiplyScalar(1E4);var maxFriction=perpForce*FRICTION_DYNAMIC_CHASSIS;var testFriction=perpForce*FRICTION_STATIC_CHASSIS;var leng=friction.length();if(leng>testFriction)friction.multiplyScalar(maxFriction/
leng);var force=surf.w.multiplyScalar(perpForce);force.addSelf(surf.u.multiplyScalar(friction.x));force.addSelf(surf.v.multiplyScalar(friction.y));this.body.addForceAtPoint(force,contact.surfacePos);this.crashLevel=Math.max(this.crashLevel,perpForce)}};exports.Vehicle.prototype.tickWheel=function(wheel,delta){var suspensionForce=wheel.ridePos*SUSP_CONSTANT;wheel.frictionForce.set(0,0);wheel.rideVel-=suspensionForce/WHEEL_MASS*delta;wheel.rideVel*=1/(1+SUSP_DAMPING*delta);wheel.ridePos+=wheel.rideVel*
delta;wheel.spinPos+=wheel.spinVel*delta;wheel.spinPos-=Math.floor(wheel.spinPos/TWOPI)*TWOPI;var clipPos=this.body.getLocToWorldPoint(Vec3FromArray(wheel.cfg.pos));clipPos.y+=wheel.ridePos-wheel.cfg.radius;var contactVel=this.body.getLinearVelAtPoint(clipPos);var contacts=this.sim.collide(clipPos);for(var c=0;c<contacts.length;++c){var contact=contacts[c];var surf=getSurfaceBasis(contact.normal,this.getWheelRightVector(wheel));var contactVelSurf=new Vec3(contactVel.dot(surf.u),contactVel.dot(surf.v),
contactVel.dot(surf.w));contactVelSurf.y+=wheel.spinVel*wheel.cfg.radius;this.skidLevel+=Math.sqrt(contactVelSurf.x*contactVelSurf.x+contactVelSurf.y*contactVelSurf.y);var perpForce=suspensionForce-contactVelSurf.z*CLIP_DAMPING;wheel.ridePos+=contact.depth;if(wheel.ridePos>SUSP_MAX){var overDepth=wheel.ridePos-SUSP_MAX;wheel.ridePos=SUSP_MAX;wheel.rideVel=0;perpForce=contact.depth*CLIP_CONSTANT-contactVelSurf.z*CLIP_DAMPING}if(wheel.rideVel<-contactVelSurf.z)wheel.rideVel=-contactVelSurf.z;if(perpForce>
0){var friction=(new Vec2(-contactVelSurf.x,-contactVelSurf.y)).multiplyScalar(3E3);var maxFriction=perpForce*FRICTION_DYNAMIC_WHEEL;var testFriction=perpForce*FRICTION_STATIC_WHEEL;var leng=friction.length();if(leng>testFriction)friction.multiplyScalar(maxFriction/leng);wheel.frictionForce.addSelf(friction);var force=surf.w.multiplyScalar(perpForce);force.addSelf(surf.u.multiplyScalar(friction.x));force.addSelf(surf.v.multiplyScalar(friction.y));this.body.addForceAtPoint(force,clipPos)}}};exports.Vehicle.prototype.getWheelTurnPos=
function(wheel){return(wheel.cfg.turn||0)*this.wheelTurnPos};exports.Vehicle.prototype.getWheelRightVector=function(wheel){var turnPos=this.getWheelTurnPos(wheel);var cosTurn=Math.cos(turnPos);var sinTurn=Math.sin(turnPos);var left=this.body.oriMat.getColumnX().clone();var fwd=this.body.oriMat.getColumnZ();var wheelRight=new Vec3(left.x*cosTurn-fwd.x*sinTurn,left.y*cosTurn-fwd.y*sinTurn,left.z*cosTurn-fwd.z*sinTurn);return wheelRight};exports.Vehicle.prototype.getCrashNoiseLevel=function(){if(this.crashLevel>
this.crashLevelPrev){this.crashLevelPrev=this.crashLevel*2;return this.crashLevel}else return 0};exports.Vehicle.prototype.grabSnapshot=function(){return filterObject(this,keys)}})(typeof exports==="undefined"?this[MODULE]={}:exports);var MODULE="track";
(function(exports){var LFIB4=this.LFIB4||require("./LFIB4");var THREE=this.THREE||require("../THREE");var pterrain=this.pterrain||require("./pterrain");var Vec3=THREE.Vector3;exports.Track=function(){this.config={};this.checkpoints=[];this.trees=[]};exports.Track.prototype.loadWithConfig=function(config,callback){this.config=config;this.setup();if(config.terrain){var source=new pterrain.ImageSource(config.terrain.heightmap);source.load(config.terrain.heightmap);var terrain=new pterrain.Terrain(source);terrain.scaleHz=
config.terrain.horizontalscale;terrain.scaleVt=config.terrain.verticalscale;this.terrain=terrain;terrain.loadTile(0,0,function(){var i;var random=LFIB4.LFIB4(config.randomseed);for(i=0;i<70;++i){var tree=new Vec3(50+random()*150,0,-50-random()*284);var contact=this.terrain.getContact(tree);tree.y=contact.surfacePos.y;tree.rot=random()*2*Math.PI;tree.scl=random()*3+3;tree.radius=1.2;this.trees.push(tree)}var course=config.course;var cpts=course.checkpoints;for(i=0;i<cpts.length;++i){var checkpoint=
new Vec3(cpts[i].pos[0]*course.coordscale[0],0,cpts[i].pos[1]*course.coordscale[1]);var contact=this.terrain.getContact(checkpoint);checkpoint.y=contact.surfacePos.y+2;this.checkpoints.push(checkpoint)}if(callback)callback()}.bind(this))}};exports.Track.prototype.setup=function(){}})(typeof exports==="undefined"?this[MODULE]={}:exports);var MODULE="game";
(function(exports){var THREE=this.THREE||require("../THREE");var track=this.track||require("./track");var psim=this.psim||require("./psim");var pvehicle=this.pvehicle||require("./pvehicle");var pubsub=this.pubsub||require("./pubsub");var Vec2=THREE.Vector2;exports.Progress=function(track,vehicle){this.checkpoints=track.checkpoints;this.vehicle=vehicle;this.nextCpIndex=0;this.pubsub=new pubsub.PubSub;this.lastCpDistSq=0;this.cpTimes=[]};exports.Progress.prototype.nextCheckpoint=function(i){return this.checkpoints[this.nextCpIndex+(i||
0)]||null};exports.Progress.prototype.update=function(){var vehic=this.vehicle;var nextCp=this.nextCheckpoint(0);if(nextCp){var cpVec=new Vec2(vehic.body.pos.x-nextCp.x,vehic.body.pos.z-nextCp.z);var cpDistSq=cpVec.lengthSq();var CP_TEST=64;if(cpDistSq<CP_TEST){var cpDist=Math.sqrt(cpDistSq);var lastCpDist=Math.sqrt(this.lastCpDistSq);var frac=(lastCpDist-Math.sqrt(CP_TEST))/(lastCpDist-cpDist);var time=vehic.sim.time-vehic.sim.timeStep*frac;this.advanceCheckpoint(time)}this.lastCpDistSq=cpDistSq}};
exports.Progress.prototype.finishTime=function(){return this.cpTimes[this.checkpoints.length-1]||null};exports.Progress.prototype.advanceCheckpoint=function(time){++this.nextCpIndex;this.cpTimes.push(time);this.pubsub.publish("advance")};exports.Game=function(http){this.http=http;this.track=new track.Track;this.progs=[];this.sim=new psim.Sim(1/150);this.startTime=3;this.sim.pubsub.subscribe("step",this.onSimStep.bind(this))};exports.Game.prototype.interpolatedRaceTime=function(){return this.sim.interpolatedTime()-
this.startTime};exports.Game.prototype.setTrack=function(trackUrl,callback){this.http.get({path:trackUrl},function(err,result){if(err)if(callback)callback(err);else throw new Error("Failed to fetch track: "+err);else{var config=JSON.parse(result);this.setTrackConfig(config,callback)}}.bind(this))};exports.Game.prototype.setTrackConfig=function(trackConfig,callback){this.track.loadWithConfig(trackConfig,function(){this.sim.addStaticObject(this.track.terrain);this.track.trees.forEach(function(tree){this.sim.addCylinder(tree)}.bind(this));
if(callback)callback(null,this.track)}.bind(this))};exports.Game.prototype.addCar=function(carUrl,callback){this.http.get({path:carUrl},function(err,result){if(err)if(callback)callback(err);else throw new Error("Failed to fetch car: "+err);else{var config=JSON.parse(result);this.addCarConfig(config,callback)}}.bind(this))};exports.Game.prototype.addCarConfig=function(carConfig,callback){var vehicle=new pvehicle.Vehicle(this.sim,carConfig);vehicle.body.pos.x=100;vehicle.body.pos.y=10;vehicle.body.pos.z=
-100;vehicle.body.ori=new THREE.Quaternion(0,0.5,0,0.5);vehicle.body.ori.normalize();var progress=new exports.Progress(this.track,vehicle);this.progs.push(progress);if(callback)callback(null,progress)};exports.Game.prototype.onSimStep=function(){var disabled=this.sim.time<this.startTime;this.progs.forEach(function(progress){progress.update();progress.vehicle.disabled=disabled})}})(typeof exports==="undefined"?this[MODULE]={}:exports);var require=function(module){return window[module]};var getUrlVars=function(hash){var vars={};var pieces=hash.substring(1).split("&");for(var i=0;i<pieces.length;++i){var splitPieces=pieces[i].split("=");if(splitPieces.length==2)vars[splitPieces[0]]=decodeURIComponent(splitPieces[1])}return vars};function $(id){return document.getElementById(id)}function $$(cls){return document.getElementsByClassName(cls)};(function(){var async={};var root=this,previous_async=root.async;if(typeof module!=="undefined"&&module.exports)module.exports=async;else root.async=async;async.noConflict=function(){root.async=previous_async;return async};var _forEach=function(arr,iterator){if(arr.forEach)return arr.forEach(iterator);for(var i=0;i<arr.length;i+=1)iterator(arr[i],i,arr)};var _map=function(arr,iterator){if(arr.map)return arr.map(iterator);var results=[];_forEach(arr,function(x,i,a){results.push(iterator(x,i,a))});
return results};var _reduce=function(arr,iterator,memo){if(arr.reduce)return arr.reduce(iterator,memo);_forEach(arr,function(x,i,a){memo=iterator(memo,x,i,a)});return memo};var _keys=function(obj){if(Object.keys)return Object.keys(obj);var keys=[];for(var k in obj)if(obj.hasOwnProperty(k))keys.push(k);return keys};var _indexOf=function(arr,item){if(arr.indexOf)return arr.indexOf(item);for(var i=0;i<arr.length;i+=1)if(arr[i]===item)return i;return-1};if(typeof process==="undefined"||!process.nextTick)async.nextTick=
function(fn){setTimeout(fn,0)};else async.nextTick=process.nextTick;async.forEach=function(arr,iterator,callback){if(!arr.length)return callback();var completed=0;_forEach(arr,function(x){iterator(x,function(err){if(err){callback(err);callback=function(){}}else{completed+=1;if(completed===arr.length)callback()}})})};async.forEachSeries=function(arr,iterator,callback){if(!arr.length)return callback();var completed=0;var iterate=function(){iterator(arr[completed],function(err){if(err){callback(err);
callback=function(){}}else{completed+=1;if(completed===arr.length)callback();else iterate()}})};iterate()};async.forEachLimit=function(arr,limit,iterator,callback){if(!arr.length||limit<=0)return callback();var completed=0;var started=0;var running=0;(function replenish(){if(completed===arr.length)return callback();while(running<limit&&started<arr.length){iterator(arr[started],function(err){if(err){callback(err);callback=function(){}}else{completed+=1;running-=1;if(completed===arr.length)callback();
else replenish()}});started+=1;running+=1}})()};var doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.forEach].concat(args))}};var doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.forEachSeries].concat(args))}};var _asyncMap=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,
function(err,v){results[x.index]=v;callback(err)})},function(err){callback(err,results)})};async.map=doParallel(_asyncMap);async.mapSeries=doSeries(_asyncMap);async.reduce=function(arr,memo,iterator,callback){async.forEachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v;callback(err)})},function(err){callback(err,memo)})};async.inject=async.reduce;async.foldl=async.reduce;async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();
async.reduce(reversed,memo,iterator,callback)};async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(v)results.push(x);callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter);async.filterSeries=doSeries(_filter);async.select=async.filter;
async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}});eachfn(arr,function(x,callback){iterator(x.value,function(v){if(!v)results.push(x);callback()})},function(err){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject);async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,
function(x,callback){iterator(x,function(result){if(result){main_callback(x);main_callback=function(){}}else callback()})},function(err){main_callback()})};async.detect=doParallel(_detect);async.detectSeries=doSeries(_detect);async.some=function(arr,iterator,main_callback){async.forEach(arr,function(x,callback){iterator(x,function(v){if(v){main_callback(true);main_callback=function(){}}callback()})},function(err){main_callback(false)})};async.any=async.some;async.every=function(arr,iterator,main_callback){async.forEach(arr,
function(x,callback){iterator(x,function(v){if(!v){main_callback(false);main_callback=function(){}}callback()})},function(err){main_callback(true)})};async.all=async.every;async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){if(err)callback(err);else callback(null,{value:x,criteria:criteria})})},function(err,results){if(err)return callback(err);else{var fn=function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0};
callback(null,_map(results.sort(fn),function(x){return x.value}))}})};async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks);if(!keys.length)return callback(null);var results={};var listeners=[];var addListener=function(fn){listeners.unshift(fn)};var removeListener=function(fn){for(var i=0;i<listeners.length;i+=1)if(listeners[i]===fn){listeners.splice(i,1);return}};var taskComplete=function(){_forEach(listeners.slice(0),function(fn){fn()})};addListener(function(){if(_keys(results).length===
keys.length){callback(null,results);callback=function(){}}});_forEach(keys,function(k){var task=tasks[k]instanceof Function?[tasks[k]]:tasks[k];var taskCallback=function(err){if(err){callback(err);callback=function(){}}else{var args=Array.prototype.slice.call(arguments,1);if(args.length<=1)args=args[0];results[k]=args;taskComplete()}};var requires=task.slice(0,Math.abs(task.length-1))||[];var ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},true)};if(ready())task[task.length-
1](taskCallback,results);else{var listener=function(){if(ready()){removeListener(listener);task[task.length-1](taskCallback,results)}};addListener(listener)}})};async.waterfall=function(tasks,callback){if(!tasks.length)return callback();callback=callback||function(){};var wrapIterator=function(iterator){return function(err){if(err){callback(err);callback=function(){}}else{var args=Array.prototype.slice.call(arguments,1);var next=iterator.next();if(next)args.push(wrapIterator(next));else args.push(callback);
async.nextTick(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};async.parallel=function(tasks,callback){callback=callback||function(){};if(tasks.constructor===Array)async.map(tasks,function(fn,callback){if(fn)fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1)args=args[0];callback.call(null,err,args)})},callback);else{var results={};async.forEach(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,
1);if(args.length<=1)args=args[0];results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.series=function(tasks,callback){callback=callback||function(){};if(tasks.constructor===Array)async.mapSeries(tasks,function(fn,callback){if(fn)fn(function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1)args=args[0];callback.call(null,err,args)})},callback);else{var results={};async.forEachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=
Array.prototype.slice.call(arguments,1);if(args.length<=1)args=args[0];results[k]=args;callback(err)})},function(err){callback(err,results)})}};async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){if(tasks.length)tasks[index].apply(null,arguments);return fn.next()};fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null};return fn};return makeCallback(0)};async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,
args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]);cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat);async.concatSeries=doSeries(_concat);async.whilst=function(test,iterator,callback){if(test())iterator(function(err){if(err)return callback(err);async.whilst(test,iterator,callback)});else callback()};async.until=function(test,iterator,callback){if(!test())iterator(function(err){if(err)return callback(err);
async.until(test,iterator,callback)});else callback()};async.queue=function(worker,concurrency){var workers=0;var q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,push:function(data,callback){if(data.constructor!==Array)data=[data];_forEach(data,function(task){q.tasks.push({data:task,callback:typeof callback==="function"?callback:null});if(q.saturated&&q.tasks.length==concurrency)q.saturated();async.nextTick(q.process)})},process:function(){if(workers<q.concurrency&&q.tasks.length){var task=
q.tasks.shift();if(q.empty&&q.tasks.length==0)q.empty();workers+=1;worker(task.data,function(){workers-=1;if(task.callback)task.callback.apply(task,arguments);if(q.drain&&q.tasks.length+workers==0)q.drain();q.process()})}},length:function(){return q.tasks.length},running:function(){return workers}};return q};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);if(typeof console!==
"undefined")if(err){if(console.error)console.error(err)}else if(console[name])_forEach(args,function(x){console[name](x)})}]))}};async.log=_console_fn("log");async.dir=_console_fn("dir");async.memoize=function(fn,hasher){var memo={};var queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments);var callback=args.pop();var key=hasher.apply(null,args);if(key in memo)callback.apply(null,memo[key]);else if(key in queues)queues[key].push(callback);
else{queues[key]=[callback];fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++)q[i].apply(null,arguments)}]))}};memoized.unmemoized=fn;return memoized};async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}}})();var MODULE="browserhttp";(function(exports){exports.get=function(options,callback){var xhr=new XMLHttpRequest;xhr.onload=function(){if(xhr.status==200)callback(null,xhr.responseText);else callback(xhr.status)};xhr.onerror=function(){callback("Error")};xhr.open("GET",options.path,true);xhr.send()}})(typeof exports==="undefined"?this[MODULE]={}:exports);var MODULE="audio";
(function(exports){var CallbackQueue=util.CallbackQueue;exports.WebkitAudio=function(){if(true&&"webkitAudioContext"in window){this.audio=new webkitAudioContext;this.master=this.audio.createGainNode();this.master.connect(this.audio.destination)}this.buffers={}};exports.WebkitAudio.prototype.setGain=function(gain){if(!this.audio)return;this.master.gain.value=gain};exports.WebkitAudio.prototype.getBuffer=function(url){var buffer=this.buffers[url];return buffer instanceof CallbackQueue?null:buffer||
null};exports.WebkitAudio.prototype.loadBuffer=function(url,callback){if(url in this.buffers){var buffer=this.buffers[url];if(buffer instanceof CallbackQueue)buffer.add(callback);else callback(this.buffers[url]);return}if(!this.audio)return;var cbq=new CallbackQueue(callback);this.buffers[url]=cbq;var request=new XMLHttpRequest;request.open("GET",url,true);request.responseType="arraybuffer";request.onload=function(){var buffer=this.audio.createBuffer(request.response,true);this.buffers[url]=buffer;
cbq.fire(buffer)}.bind(this);request.send()};exports.WebkitAudio.prototype.playSound=function(buffer,loop,gain,rate){var source=this.audio.createBufferSource();source.buffer=buffer;source.connect(this.master);source.loop=loop;source.gain.value=gain;source.playbackRate.value=rate===undefined?1:rate;source.noteOn(0);return source}})(typeof exports==="undefined"?this[MODULE]={}:exports);var Car=function(){this.bodyGeometry=null;this.wheelGeometry=null;this.root=new THREE.Object3D;this.root.useQuaternion=true;this.bodyMesh=null;this.wheels=[];this.vehic=null;this.config={};this.sourceEngine=null;this.sourceTransmission=null;this.sourceWind=null;this.sourceSkid=null;this.buffersCrash=[];this.loadWithVehicle=function(vehicle,callback){this.vehic=vehicle;this.config=vehicle.cfg;this.loadPartsJSON(this.config.meshes.body,this.config.meshes.wheel,callback)};this.loadPartsJSON=function(bodyURL,
wheelURL,callback){var loader=new THREE.JSONLoader;var texturePath="/a/textures";async.parallel({body:function(cb){loader.load(bodyURL,function(geometry){cb(null,geometry)},texturePath)},wheel:function(cb){loader.load(wheelURL,function(geometry){cb(null,geometry)},texturePath)}},function(err,data){if(err)throw err;else{this.bodyGeometry=data.body;this.wheelGeometry=data.wheel;this.createCar();callback()}}.bind(this))};this.update=function(){if(!this.vehic)return;var chassisState=this.vehic.body.interp;
this.root.position.copy(chassisState.pos);this.root.quaternion.copy(chassisState.ori);for(var w=0;w<this.wheels.length;++w){var wheel=this.wheels[w];var vWheel=this.vehic.wheels[w];wheel.root.position.y=wheel.cfg.pos[1]+vWheel.ridePos;wheel.root.rotation.y=this.vehic.getWheelTurnPos(vWheel);wheel.mesh.rotation.x=vWheel.spinPos}if(this.aud){if(this.sourceEngine){this.sourceEngine.gain.value=this.vehic.controller.output.throttle*0.2+0.4;this.sourceEngine.playbackRate.value=this.vehic.engineAngVelSmoothed/
(this.config.sounds.engineRpm*Math.PI/30)}if(this.sourceTransmission){var transmissionRate=this.vehic.differentialAngVel/(this.config.sounds.transmissionRpm*Math.PI/30);this.sourceTransmission.gain.value=Math.min(1,transmissionRate)*this.vehic.controller.output.throttle*0.08;this.sourceTransmission.playbackRate.value=transmissionRate}if(this.sourceWind){var linVel=this.vehic.body.linVel;var windRate=linVel.length()/this.config.sounds.windSpeed;this.sourceWind.gain.value=Math.min(1.4,windRate)*1.4;
this.sourceWind.playbackRate=windRate+0.5}if(this.sourceSkid)this.sourceSkid.gain.value=Math.log(1+this.vehic.skidLevel*0.05);var cnl=this.vehic.getCrashNoiseLevel()*5.0E-6;if(cnl>0&&this.buffersCrash.length>0)this.aud.playSound(this.buffersCrash[Math.floor(Math.random()*this.buffersCrash.length)],false,Math.log(1+cnl),0.99+Math.random()*0.02)}};this.createCar=function(){var i;var center=Vec3FromArray(this.config.center);var s=this.config.scale||1,faceMaterial=new THREE.MeshFaceMaterial;this.bodyMesh=
new THREE.Mesh(this.bodyGeometry,faceMaterial);this.bodyMesh.position.copy(center).multiplyScalar(-1);this.bodyMesh.scale.set(s,s,s);this.root.add(this.bodyMesh);for(i=0;i<this.config.wheels.length;++i){var cfg=this.config.wheels[i];var wheel={};wheel.cfg=cfg;wheel.mesh=new THREE.Mesh(this.wheelGeometry,faceMaterial);wheel.mesh.scale.set(s,s,s);if(cfg.flip)wheel.mesh.rotation.z=Math.PI;wheel.root=new THREE.Object3D;wheel.root.position=new THREE.Vector3(cfg.pos[0],cfg.pos[1],cfg.pos[2]);wheel.root.add(wheel.mesh);
this.root.add(wheel.root);this.wheels.push(wheel)}if(this.aud){var sounds=this.config.sounds;this.aud.loadBuffer(sounds.engine,function(buffer){this.sourceEngine=this.aud.playSound(buffer,true,0)}.bind(this));this.aud.loadBuffer(sounds.transmission,function(buffer){this.sourceTransmission=this.aud.playSound(buffer,true,0)}.bind(this));this.aud.loadBuffer(sounds.wind,function(buffer){this.sourceWind=this.aud.playSound(buffer,true,0)}.bind(this));this.aud.loadBuffer(sounds.skid,function(buffer){this.sourceSkid=
this.aud.playSound(buffer,true,0)}.bind(this));for(var c=0;c<sounds.crash.length;++c)this.aud.loadBuffer(sounds.crash[c],function(c,buffer){this.buffersCrash[c]=buffer}.bind(this,c))}}};var SCREEN_WIDTH,SCREEN_HEIGHT,SCREEN_ASPECT;var SHADOW_MAP_WIDTH=1024,SHADOW_MAP_HEIGHT=1024;var KEYCODE=util.KEYCODE;var PULLTOWARD=util.PULLTOWARD;var Vec2=THREE.Vector2;var Vec3=THREE.Vector3;var Vec3FromArray=util.Vec3FromArray;var stats;var sceneHUD,cameraHUD;var revMeter;var scene,camera;var debugMesh;var webglRenderer;var sunLight,sunLightPos;var cameraMode=0,CAMERA_MODES=3;var trees=[];var meshCheckpoint;var meshArrow,meshArrowNext;var containerEl=$$("frame3d")[0];var checkpointsEl=$("checkpoints");
var countdownEl=$("countdown");var runTimerEl=$("timer");var twitterLinkEl=$("twitterlink");var fullscreenLinkEl=$("fullscreenlink");var saveReplayLinkEl=$("savereplaylink");var replaysContainerEl=$("replays");var keyDown=[];var textureCube;var game;var car;var followProgress;var updateTimer=true;var lastRaceTime=0;var carRecorder1,carRecorder2;var replayPlayback1,replayPlayback2;var aud;var checkpointBuffer;var sourcesTmp=[];var windowHalfX=window.innerWidth/2;
var windowHalfY=window.innerHeight/2;document.addEventListener("mousemove",onDocumentMouseMove,false);document.addEventListener("keydown",onDocumentKeyDown,false);document.addEventListener("keyup",onDocumentKeyUp,false);var lastTime=Date.now();init();
function init(){if(!Detector.webgl){Detector.addGetWebGLMessage();var loadingEl=document.getElementsByClassName("loading")[0];loadingEl.className+=" loaded";return false}sceneHUD=new THREE.Scene;cameraHUD=new THREE.OrthographicCamera(-SCREEN_ASPECT,SCREEN_ASPECT,-1,1,-1,1);sceneHUD.add(cameraHUD);var revMeterGeom=new THREE.Geometry;revMeterGeom.vertices.push(new Vec3(1,0,0));revMeterGeom.vertices.push(new Vec3(-0.1,-0.02,0));revMeterGeom.vertices.push(new Vec3(-0.1,0.02,0));revMeterGeom.faces.push(new THREE.Face3(0,
1,2));revMeterGeom.computeCentroids();var revMeterMat=new THREE.MeshBasicMaterial;revMeter=new THREE.Mesh(revMeterGeom,revMeterMat);revMeter.position.x=-1.5;revMeter.scale.multiplyScalar(0.4);scene=new THREE.Scene;camera=new THREE.PerspectiveCamera(75,1,0.1,1E5);camera.position.x=2;camera.position.y=2;camera.position.z=2;scene.add(camera);var debugGeometry=new THREE.SphereGeometry(0.2,16,8);var debugMaterial=new THREE.MeshBasicMaterial;debugMesh=new THREE.Mesh(debugGeometry,debugMaterial);scene.add(debugMesh);
scene.fog=new THREE.FogExp2(14540253,0.0010);var ambient=new THREE.AmbientLight(4482688);scene.add(ambient);sunLightPos=new Vec3(0,10,-15);sunLight=new THREE.DirectionalLight(16769211);sunLight.intensity=1.3;sunLight.position.copy(sunLightPos);sunLight.castShadow=true;sunLight.shadowCameraNear=-20;sunLight.shadowCameraFar=60;sunLight.shadowCameraLeft=-24;sunLight.shadowCameraRight=24;sunLight.shadowCameraTop=24;sunLight.shadowCameraBottom=-24;sunLight.shadowDarkness=0.4;sunLight.shadowMapWidth=SHADOW_MAP_WIDTH;
sunLight.shadowMapHeight=SHADOW_MAP_HEIGHT;scene.add(sunLight);webglRenderer=new THREE.WebGLRenderer({antialias:false});webglRenderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT);webglRenderer.shadowMapEnabled=true;webglRenderer.shadowMapSoft=true;webglRenderer.shadowMapCullFrontFaces=false;webglRenderer.autoClear=false;onWindowResize();containerEl.appendChild(webglRenderer.domElement);fullscreenLinkEl.addEventListener("click",function(ev){var el=containerEl;var reqFS=el.requestFullScreenWithKeys||el.webkitRequestFullScreenWithKeys||
el.mozRequestFullScreenWithKeys||el.requestFullScreen||el.webkitRequestFullScreen||el.mozRequestFullScreen;reqFS.bind(el)()});var onFullScreenChange=function(ev){_.delay(onWindowResize,1E3)};document.addEventListener("fullscreenchange",onFullScreenChange);document.addEventListener("mozfullscreenchange",onFullScreenChange);document.addEventListener("webkitfullscreenchange",onFullScreenChange);saveReplayLinkEl&&saveReplayLinkEl.addEventListener("click",function(ev){uploadRun()});if(typeof Stats!="undefined"){stats=
new Stats;stats.domElement.style.position="absolute";stats.domElement.style.top="0px";stats.domElement.style.zIndex=100;containerEl.appendChild(stats.domElement)}var path="/a/textures/Teide-1024/";var format=".jpg";var urls=[path+"posx"+format,path+"negx"+format,path+"posy"+format,path+"negy"+format,path+"posz"+format,path+"negz"+format];textureCube=THREE.ImageUtils.loadTextureCube(urls);drawCube();drawCheckpoint();drawArrow();aud=new audio.WebkitAudio;aud.loadBuffer("/a/sounds/checkpoint.wav",function(buffer){checkpointBuffer=
buffer});var loader=new THREE.JSONLoader;var texturePath="/a/textures";game=new game.Game(browserhttp);async.parallel({track:function(cb){game.setTrackConfig(TRIGGER.TRACK.CONFIG,cb)},car:function(cb){game.addCarConfig(TRIGGER.CAR.CONFIG,function(err,progress){if(err)throw new Error(err);followProgress=progress;if(TRIGGER.RUN){replayPlayback1=new recorder.StatePlayback(progress.vehicle.controller.input,TRIGGER.RUN.INPUT);replayPlayback2=new recorder.StatePlayback(progress,TRIGGER.RUN.PROGRESS);game.sim.pubsub.subscribe("step",
function(){replayPlayback1.step();replayPlayback2.step()});replayPlayback1.pubsub.subscribe("complete",function(){checkpointsEl.innerHTML="Replay complete";updateTimer=false})}else{var keys1={forward:0,back:0,left:0,right:0,handbrake:0};var keys2={nextCpIndex:0,vehicle:{body:{pos:{x:3,y:3,z:3},ori:{x:3,y:3,z:3,w:3},linVel:{x:3,y:3,z:3},angVel:{x:3,y:3,z:3}},wheels:[{spinVel:1}],engineAngVel:3}};carRecorder1=new recorder.StateRecorder(progress.vehicle.controller.input,keys1,2);carRecorder2=new recorder.StateRecorder(progress,
keys2,40);game.sim.pubsub.subscribe("step",function(){carRecorder1.observe();carRecorder2.observe()})}car=new Car;car.aud=aud;car.loadWithVehicle(progress.vehicle,cb);progress.pubsub.subscribe("advance",advanceCheckpoint)})},geomTrunk:function(cb){loader.load("/a/meshes/tree1a_lod2_tex_000.json",function(geometry){cb(null,geometry)},texturePath)},geomLeaves:function(cb){loader.load("/a/meshes/tree1a_lod2_tex_001.json",function(geometry){cb(null,geometry)},texturePath)}},function(err,data){if(err)throw new Error(err);
else{drawTrack(data.track.terrain.getTile(0,0));drawTrees(data.geomTrunk,data.geomLeaves);var bodyMaterial=car.bodyGeometry.materials[0];bodyMaterial.envMap=textureCube;bodyMaterial.combine=THREE.MixOperation;bodyMaterial.reflectivity=0.1;bodyMaterial.wrapAround=0;bodyMaterial.ambient=bodyMaterial.color;var wheelMaterial=car.wheelGeometry.materials[0];wheelMaterial.ambient=wheelMaterial.color;car.bodyMesh.castShadow=true;car.bodyMesh.receiveShadow=true;for(var w=0;w<car.wheels.length;++w){car.wheels[w].mesh.castShadow=
true;car.wheels[w].mesh.receiveShadow=true}scene.add(car.root);var loadingEl=document.getElementsByClassName("loading")[0];loadingEl.className+=" loaded";requestAnimationFrame(animate)}});return true}
function drawTrees(geomTrunk,geomLeaves){var matTrunk=geomTrunk.materials[0];matTrunk.ambient=matTrunk.color;var matLeaves=geomLeaves.materials[0];matLeaves.ambient=matLeaves.color;matLeaves.depthWrite=false;matLeaves.transparent=true;var i;for(i=0;i<game.track.trees.length;++i){var tree=game.track.trees[i];var mesh=new THREE.Mesh(geomTrunk,matTrunk);mesh.castShadow=true;mesh.receiveShadow=true;mesh.scale.set(tree.scl,tree.scl,tree.scl);mesh.position.copy(tree);mesh.rotation.y=tree.rot;scene.add(mesh);
mesh=new THREE.Mesh(geomLeaves,matLeaves);mesh.castShadow=true;mesh.doubleSided=true;mesh.scale.set(tree.scl,tree.scl,tree.scl);mesh.position.copy(tree);mesh.rotation.y=tree.rot;scene.add(mesh)}}
function drawCube(){var cubeShader=THREE.ShaderUtils.lib["cube"];cubeShader.uniforms["tCube"].texture=textureCube;var cubeMaterial=new THREE.ShaderMaterial({fragmentShader:cubeShader.fragmentShader,vertexShader:cubeShader.vertexShader,uniforms:cubeShader.uniforms});var cubeMesh=new THREE.Mesh(new THREE.CubeGeometry(1E5,1E5,1E5),cubeMaterial);cubeMesh.geometry.faces.splice(3,1);cubeMesh.flipSided=true;cubeMesh.position.set(0,-1E3,0);scene.add(cubeMesh)}
function drawCheckpoint(){var mat=new THREE.MeshBasicMaterial({color:1060880,blending:THREE.AdditiveBlending,transparent:1,depthWrite:false});var geom=new THREE.Geometry;var ringGeom=new THREE.CylinderGeometry(6,6,0.2,32,1,true);var ringMesh=new THREE.Mesh(ringGeom,mat);ringMesh.rotation.z=0.4;THREE.GeometryUtils.merge(geom,ringMesh);ringMesh.rotation.y=Math.PI*2/3;THREE.GeometryUtils.merge(geom,ringMesh);ringMesh.rotation.y=Math.PI*4/3;THREE.GeometryUtils.merge(geom,ringMesh);meshCheckpoint=new THREE.Mesh(geom,
mat);meshCheckpoint.doubleSided=true;meshCheckpoint.castShadow=true;scene.add(meshCheckpoint)}
function drawArrow(){var mat=new THREE.MeshBasicMaterial({color:2121760,blending:THREE.AdditiveBlending,transparent:1,depthWrite:false});var mat2=new THREE.MeshBasicMaterial({color:331781,blending:THREE.AdditiveBlending,transparent:1,depthWrite:false});var geom=new THREE.Geometry;geom.vertices.push(new Vec3(0,0,0.6));geom.vertices.push(new Vec3(0.1,0,0.3));geom.vertices.push(new Vec3(-0.1,0,0.3));geom.vertices.push(new Vec3(0.1,0,-0.2));geom.vertices.push(new Vec3(-0.1,0,-0.2));geom.faces.push(new THREE.Face3(0,
2,1));geom.faces.push(new THREE.Face4(1,2,4,3));meshArrow=new THREE.Mesh(geom,mat);meshArrow.position.set(0,1,-2);meshArrowNext=new THREE.Mesh(geom,mat2);meshArrowNext.position.set(0,0,0.8);camera.add(meshArrow);meshArrow.add(meshArrowNext)}
var drawTrack=function(terrainTile){var terrain=terrainTile.terrain;var geometry=new THREE.PlaneGeometry(1,1,terrainTile.size,terrainTile.size);var x,y,i=0;for(y=0;y<=terrainTile.size;++y)for(x=0;x<=terrainTile.size;++x){geometry.vertices[i].x=x*terrain.scaleHz;geometry.vertices[i].y=y*terrain.scaleHz;geometry.vertices[i].z=terrainTile.heightMap[i];++i}for(i=0;i<geometry.faces.length;++i){x=geometry.faces[i].a;geometry.faces[i].a=geometry.faces[i].c;geometry.faces[i].c=x;x=geometry.faceVertexUvs[0][i][0];
geometry.faceVertexUvs[0][i][0]=geometry.faceVertexUvs[0][i][2];geometry.faceVertexUvs[0][i][2]=x}geometry.computeCentroids();geometry.computeFaceNormals();geometry.computeVertexNormals();var tarmac_d=THREE.ImageUtils.loadTexture("/a/textures/mayang-earth.jpg");tarmac_d.wrapS=tarmac_d.wrapT=THREE.RepeatWrapping;tarmac_d.repeat.set(100,100);var xm=new THREE.MeshLambertMaterial({map:tarmac_d,wrapAround:false});xm.ambient=xm.color;var mesh=new THREE.Mesh(geometry,xm);mesh.position.set(0,0,0);mesh.rotation.x=
-Math.PI/2;mesh.castShadow=false;mesh.receiveShadow=true;scene.add(mesh)};function onDocumentMouseMove(event){mouseX=(event.clientX-windowHalfX)*0.01;mouseY=(event.clientY-windowHalfY)*0.01}function keyWeCareAbout(event){return!event.shiftKey&&!event.ctrlKey&&!event.metaKey&&event.keyCode>=32&&event.keyCode<=127}
function onDocumentKeyDown(event){if(keyWeCareAbout(event)){if(false&&!(event.keyCode in keyDown))console.log("KeyDown: "+event.keyCode);keyDown[event.keyCode]=true;switch(event.keyCode){case KEYCODE["C"]:cameraMode=(cameraMode+1)%CAMERA_MODES}event.preventDefault();return false}}function onDocumentKeyUp(event){if(keyWeCareAbout(event)){keyDown[event.keyCode]=false;event.preventDefault();return false}}
function onWindowResize(){SCREEN_WIDTH=containerEl.clientWidth;SCREEN_HEIGHT=containerEl.clientHeight;SCREEN_ASPECT=SCREEN_HEIGHT>0?SCREEN_WIDTH/SCREEN_HEIGHT:1;webglRenderer.setSize(SCREEN_WIDTH,SCREEN_HEIGHT);camera.aspect=SCREEN_ASPECT;camera.updateProjectionMatrix()}var debouncedMuteAudio=_.debounce(function(){aud.setGain(0)},500);function muteAudioIfStopped(){aud.setGain(1);debouncedMuteAudio()}
function animate(){var nowTime=Date.now();var delta=Math.min((nowTime-lastTime)*0.0010,0.1);lastTime=nowTime;var nextCp=followProgress.nextCheckpoint(0);var nextCpNext=followProgress.nextCheckpoint(1);if(nextCp){var cpPull=delta*2;meshCheckpoint.position.x=PULLTOWARD(meshCheckpoint.position.x,nextCp.x,cpPull);meshCheckpoint.position.y=PULLTOWARD(meshCheckpoint.position.y,nextCp.y,cpPull);meshCheckpoint.position.z=PULLTOWARD(meshCheckpoint.position.z,nextCp.z,cpPull);meshCheckpoint.rotation.y+=delta*
3}if(updateTimer){var raceTime=game.interpolatedRaceTime();if(raceTime>=0){if(lastRaceTime<0){countdownEl.innerHTML="Go!";countdownEl.className+=" fadeout";checkpointsEl.innerHTML=followProgress.nextCpIndex+" / "+game.track.checkpoints.length}runTimerEl.innerHTML=formatRunTime(raceTime)}else{var num=Math.ceil(-raceTime);var lastNum=Math.ceil(-lastRaceTime);if(num!=lastNum)countdownEl.innerHTML=num}lastRaceTime=raceTime}if(!TRIGGER.RUN){var controls=car.vehic.controller.input;controls.forward=keyDown[KEYCODE["UP"]]||
keyDown[KEYCODE["W"]]?1:0;controls.back=keyDown[KEYCODE["DOWN"]]||keyDown[KEYCODE["S"]]?1:0;controls.left=keyDown[KEYCODE["LEFT"]]||keyDown[KEYCODE["A"]]?1:0;controls.right=keyDown[KEYCODE["RIGHT"]]||keyDown[KEYCODE["D"]]?1:0;controls.handbrake=keyDown[KEYCODE["SPACE"]]?1:0}game.sim.tick(delta);car.update();if(nextCp){var cpVec=new Vec2(car.vehic.body.pos.x-nextCp.x,car.vehic.body.pos.z-nextCp.z);cpVec=new Vec2(car.vehic.body.pos.x-meshCheckpoint.position.x,car.vehic.body.pos.z-meshCheckpoint.position.z);
var cpVecCamSpace=new Vec2(cpVec.x*camera.matrixWorld.elements[2]-cpVec.y*camera.matrixWorld.elements[10],cpVec.x*camera.matrixWorld.elements[0]-cpVec.y*camera.matrixWorld.elements[8]);meshArrow.rotation.y=Math.atan2(-cpVecCamSpace.y,cpVecCamSpace.x)}if(nextCpNext){cpVec=new Vec2(car.vehic.body.pos.x-nextCpNext.x,car.vehic.body.pos.z-nextCpNext.z);cpVecCamSpace=new Vec2(cpVec.x*camera.matrixWorld.elements[2]-cpVec.y*camera.matrixWorld.elements[10],cpVec.x*camera.matrixWorld.elements[0]-cpVec.y*camera.matrixWorld.elements[8]);
meshArrowNext.rotation.y=Math.atan2(-cpVecCamSpace.y,cpVecCamSpace.x)-meshArrow.rotation.y}var linVel=car.vehic.body.linVel;var pull=delta*20;camera.quaternion.x=PULLTOWARD(camera.quaternion.x,-car.root.quaternion.z,pull);camera.quaternion.y=PULLTOWARD(camera.quaternion.y,car.root.quaternion.w,pull);camera.quaternion.z=PULLTOWARD(camera.quaternion.z,car.root.quaternion.x,pull);camera.quaternion.w=PULLTOWARD(camera.quaternion.w,-car.root.quaternion.y,pull);camera.quaternion.normalize();switch(cameraMode){case 0:var targetPos=
car.root.position.clone();targetPos.addSelf(linVel.clone().multiplyScalar(0.17));if(1){targetPos.addSelf(car.root.matrix.getColumnX().clone().multiplyScalar(0));targetPos.addSelf(car.root.matrix.getColumnY().clone().multiplyScalar(1.2));targetPos.addSelf(car.root.matrix.getColumnZ().clone().multiplyScalar(-2.9))}else{targetPos.addSelf(car.root.matrix.getColumnX().clone().multiplyScalar(2));targetPos.addSelf(car.root.matrix.getColumnY().clone().multiplyScalar(0.2));targetPos.addSelf(car.root.matrix.getColumnZ().clone().multiplyScalar(-0.5))}var camDelta=
delta*5;camera.position.x=PULLTOWARD(camera.position.x,targetPos.x,camDelta);camera.position.y=PULLTOWARD(camera.position.y,targetPos.y,camDelta);camera.position.z=PULLTOWARD(camera.position.z,targetPos.z,camDelta);camera.useQuaternion=false;var lookPos=car.root.position.clone();lookPos.addSelf(car.root.matrix.getColumnY().clone().multiplyScalar(0.7));camera.lookAt(lookPos);break;case 1:camera.useQuaternion=true;camera.updateMatrix();camera.position.x=car.root.position.x+camera.matrix.elements[1]*
0.7;camera.position.y=car.root.position.y+camera.matrix.elements[5]*0.7;camera.position.z=car.root.position.z+camera.matrix.elements[9]*0.7;camera.matrix.setPosition(camera.position);break;case 2:camera.useQuaternion=true;camera.updateMatrix();var camUp=new Vec3(camera.matrix.elements[4],camera.matrix.elements[5],camera.matrix.elements[6]);var camRight=new Vec3(camera.matrix.elements[0],camera.matrix.elements[1],camera.matrix.elements[2]);camera.position.add(car.root.position,camUp.multiplyScalar(0));
camera.position.addSelf(camRight.multiplyScalar(1));camera.matrix.setPosition(camera.position);break}var cameraClip=camera.position.clone();cameraClip.y-=0.1;var ctc=game.sim.collide(cameraClip);for(var c=0;c<ctc.length;++c)if(camera.position.y<ctc[c].surfacePos.y+0.1)camera.position.y=ctc[c].surfacePos.y+0.1;sunLight.target.position.copy(car.root.position);sunLight.position.copy(car.root.position).addSelf(sunLightPos);sunLight.updateMatrixWorld();sunLight.target.updateMatrixWorld();revMeter.rotation.z=
2.5+4.5*((car.vehic.engineAngVelSmoothed-car.vehic.engineIdle)/(car.vehic.engineRedline-car.vehic.engineIdle));render();if(stats)stats.update();muteAudioIfStopped();requestAnimationFrame(animate)}function padZero(val,digits){return(1E15+val+"").slice(-digits)}function formatRunTime(time){var mins=Math.floor(time/60);time-=mins*60;var secs=Math.floor(time);time-=secs;var cents=Math.floor(time*100);return mins+":"+padZero(secs,2)+"."+padZero(cents,2)}
function advanceCheckpoint(){if(checkpointBuffer)aud.playSound(checkpointBuffer,false,1,1);checkpointsEl.innerHTML=followProgress.nextCpIndex+" / "+game.track.checkpoints.length;var nextCp=followProgress.nextCheckpoint(0);if(!nextCp){updateTimer=false;runTimerEl.className="";if(!TRIGGER.RUN)if(TRIGGER.USER_LOGGED_IN)_.delay(uploadRun,1E3);else showTwitterLink()}}
function uploadRun(){var formData=new FormData;formData.append("user",TRIGGER.USER_LOGGED_IN);formData.append("track",TRIGGER.TRACK.ID);formData.append("car",TRIGGER.CAR.ID);var time=followProgress.finishTime();if(time)time-=game.startTime;formData.append("time",JSON.stringify(time));formData.append("record_i",JSON.stringify(carRecorder1.serialize()));formData.append("record_p",JSON.stringify(carRecorder2.serialize()));var request=new XMLHttpRequest;var url="/run/new";request.open("POST",url,true);
request.onload=function(){var runId=JSON.parse(request.responseText).run;var linkEl=document.createElement("a");linkEl.innerHTML="View stats and replay";linkEl.href="/run/"+runId;linkEl.className="highlight";replaysContainerEl.appendChild(linkEl);_.defer(function(){linkEl.className=""})};request.send(formData)}
function showTwitterLink(){var exclamations=["Radial!","Galvanized!","Totally slipstream!","Arboreal!","Spintastic!"];var exclamation=exclamations[Math.floor(Math.random()*exclamations.length)];twitterLinkEl.href=getTwitterLink("Just finished "+TRIGGER.TRACK.NAME+" with the "+TRIGGER.CAR.NAME+" in "+runTimerEl.innerHTML+". "+exclamation+" @TriggerRally");twitterLinkEl.className="visible"}function getTwitterLink(text){return"http://twitter.com/intent/tweet?text="+encodeURIComponent(text)}
function render(){webglRenderer.clear(true,true);webglRenderer.render(scene,camera)};
